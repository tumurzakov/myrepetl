# Архитектура многопоточного ETL сервиса

## Диаграмма архитектуры

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                ETLService                                      │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────────────┐ │
│  │  ConfigService  │    │  ThreadManager  │    │     Signal Handlers        │ │
│  └─────────────────┘    └─────────────────┘    └─────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              ThreadManager                                     │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────────────┐ │
│  │   MessageBus    │    │ SourceThreadSvc │    │    TargetThreadSvc          │ │
│  │                 │    │                 │    │                             │ │
│  │ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────────────────┐ │ │
│  │ │Message Queue│ │    │ │SourceThread1│ │    │ │     TargetThread1       │ │ │
│  │ │             │ │    │ │             │ │    │ │                         │ │ │
│  │ │ ┌─────────┐ │ │    │ │ ┌─────────┐ │ │    │ │ ┌─────────────────────┐ │ │ │
│  │ │ │Message  │ │ │    │ │ │BinLog   │ │ │    │ │ │   Event Queue      │ │ │ │
│  │ │ │Process  │ │ │    │ │ │Stream   │ │ │    │ │ │                     │ │ │ │
│  │ │ │Thread   │ │ │    │ │ │Reader   │ │ │    │ │ │ ┌─────────────────┐ │ │ │ │
│  │ │ └─────────┘ │ │    │ │ └─────────┘ │ │    │ │ │ │Event Processor  │ │ │ │ │
│  │ └─────────────┘ │    │ └─────────────┘ │    │ │ │ └─────────────────┘ │ │ │ │
│  └─────────────────┘    │                 │    │ │ └─────────────────────┘ │ │ │
│                         │ ┌─────────────┐ │    │ └─────────────────────────┘ │ │
│                         │ │SourceThread2│ │    │                             │ │
│                         │ │             │ │    │ ┌─────────────────────────┐ │ │
│                         │ │ ┌─────────┐ │ │    │ │     TargetThread2       │ │ │
│                         │ │ │BinLog   │ │ │    │ │                         │ │ │
│                         │ │ │Stream   │ │ │    │ │ ┌─────────────────────┐ │ │ │
│                         │ │ │Reader   │ │ │    │ │ │   Event Queue      │ │ │ │
│                         │ │ └─────────┘ │ │    │ │ │                     │ │ │ │
│                         │ └─────────────┘ │    │ │ │ ┌─────────────────┐ │ │ │ │
│                         └─────────────────┘    │ │ │ │Event Processor  │ │ │ │ │
│                                                 │ │ │ └─────────────────┘ │ │ │ │
│                                                 │ │ └─────────────────────┘ │ │ │
│                                                 │ └─────────────────────────┘ │ │
│                                                 └─────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Message Bus                                       │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        Message Types                                       │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │ │
│  │  │BINLOG_EVENT │  │  SHUTDOWN   │  │   ERROR     │  │   HEARTBEAT     │  │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        Subscribers                                        │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │ │
│  │  │SourceThreads│  │TargetThreads│  │Monitoring   │  │   Error Handler  │  │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            Data Sources                                        │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────────────┐ │
│  │   MySQL DB 1    │    │   MySQL DB 2    │    │      PostgreSQL DB         │ │
│  │                 │    │                 │    │                             │ │
│  │ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────────────────┐ │ │
│  │ │BinLog Stream│ │    │ │BinLog Stream│ │    │ │   WAL Stream            │ │ │
│  │ │             │ │    │ │             │ │    │ │                         │ │ │
│  │ │ ┌─────────┐ │ │    │ │ ┌─────────┐ │ │    │ │ ┌─────────────────────┐ │ │ │
│  │ │ │Events   │ │ │    │ │ │Events   │ │ │    │ │ │Events               │ │ │ │
│  │ │ │INSERT   │ │ │    │ │ │INSERT   │ │ │    │ │ │INSERT               │ │ │ │
│  │ │ │UPDATE   │ │ │    │ │ │UPDATE   │ │ │    │ │ │UPDATE               │ │ │ │
│  │ │ │DELETE   │ │ │    │ │ │DELETE   │ │ │    │ │ │DELETE               │ │ │ │
│  │ │ └─────────┘ │ │    │ │ └─────────┘ │ │    │ │ └─────────────────────┘ │ │ │
│  │ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────────────────┘ │ │
│  └─────────────────┘    └─────────────────┘    └─────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            Data Targets                                        │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────────────┐ │
│  │ Data Warehouse  │    │ Analytics DB    │    │      Backup DB             │ │
│  │                 │    │                 │    │                             │ │
│  │ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────────────────┐ │ │
│  │ │Transformed  │ │    │ │Aggregated   │ │    │ │     Raw Data            │ │ │
│  │ │Data         │ │    │ │Data         │ │    │ │                         │ │ │
│  │ └─────────────┘ │    │ └─────────────┘ │    │ │ ┌─────────────────────┐ │ │ │
│  │                 │    │                 │    │ │ │Full Replication     │ │ │ │
│  │ ┌─────────────┐ │    │ ┌─────────────┐ │    │ │ └─────────────────────┘ │ │ │
│  │ │UPSERT       │ │    │ │UPSERT       │ │    │ └─────────────────────────┘ │ │
│  │ │Operations   │ │    │ │Operations   │ │    │                             │ │
│  │ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────────────────┘ │ │
│  └─────────────────┘    └─────────────────┘    └─────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Потоки данных

### 1. Источники данных (Source Threads)
- Каждый источник работает в отдельном потоке
- Читает события из BinLog/WAL потоков
- Отправляет события в Message Bus

### 2. Шина сообщений (Message Bus)
- Центральная точка обмена сообщениями
- Thread-safe очередь сообщений
- Подписчики получают события по типам

### 3. Приемники данных (Target Threads)
- Каждый приемник работает в отдельном потоке
- Получает события из Message Bus
- Применяет фильтры и трансформации
- Выполняет операции UPSERT/DELETE

### 4. Управление жизненным циклом
- ThreadManager координирует все потоки
- Graceful shutdown при получении сигналов
- Мониторинг состояния системы

## Ключевые особенности

### Параллелизм
- ✅ Все источники активны одновременно
- ✅ События обрабатываются параллельно
- ✅ Нет блокировок между источниками

### Масштабируемость
- ✅ Легко добавлять новые источники
- ✅ Легко добавлять новые приемники
- ✅ Независимое масштабирование компонентов

### Надежность
- ✅ Изоляция ошибок между потоками
- ✅ Автоматическое восстановление
- ✅ Graceful shutdown

### Производительность
- ✅ Высокая пропускная способность
- ✅ Минимальные задержки
- ✅ Эффективное использование ресурсов

## Решение проблемы блокировки

### Проблема (старая архитектура)
```
Source1 ──┐
          ├── Round Robin ──► ETL Service ──► Target
Source2 ──┘
          ↑
    Блокировка на fetchone()
```

### Решение (новая архитектура)
```
Source1 ──┐
          ├── Message Bus ──┐
Source2 ──┘                 ├── Target1
                            ├── Target2
Source3 ──┐                 └── Target3
          └── Message Bus ──┘
```

Каждый источник работает независимо в своем потоке!

